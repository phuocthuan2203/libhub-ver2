<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Catalog - LibHub</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <nav></nav>

    <div class="container">
        <div class="search-section">
            <h2>Browse Books</h2>
            <div class="search-controls">
                <input type="text" id="searchInput" placeholder="Search by title, author, or ISBN...">
                <select id="genreFilter">
                    <option value="">All Genres</option>
                </select>
                <button onclick="searchBooks()" class="btn-primary">Search</button>
            </div>
        </div>

        <div id="bookGrid" class="book-grid"></div>
        
        <div id="emptyState" class="empty-state" style="display: none;">
            <h3>No books found</h3>
            <p>Try adjusting your search criteria</p>
        </div>
    </div>

    <script src="js/api-client.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/ui-utils.js"></script>
    <script>
        updateNavigation();
        
        let isLoading = false;
        let allGenres = new Set();
        
        async function loadGenres() {
            try {
                const books = await apiClient.get('/api/books');
                books.forEach(book => {
                    if (book.genre) {
                        allGenres.add(book.genre);
                    }
                });
                
                const genreFilter = document.getElementById('genreFilter');
                genreFilter.innerHTML = '<option value="">All Genres</option>';
                
                Array.from(allGenres).sort().forEach(genre => {
                    const option = document.createElement('option');
                    option.value = genre;
                    option.textContent = genre;
                    genreFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load genres:', error);
            }
        }
        
        async function loadBooks(search = '', genre = '') {
            if (isLoading) return;
            
            isLoading = true;
            showSkeletonLoading('bookGrid', 6);
            document.getElementById('emptyState').style.display = 'none';
            
            try {
                const params = new URLSearchParams();
                if (search) params.append('search', search);
                if (genre) params.append('genre', genre);
                
                const queryString = params.toString();
                const endpoint = queryString ? `/api/books?${queryString}` : '/api/books';
                
                const books = await apiClient.get(endpoint);
                renderBooks(books);
            } catch (error) {
                handleApiError(error, 'Failed to load books');
                document.getElementById('bookGrid').innerHTML = '';
                document.getElementById('emptyState').style.display = 'block';
            } finally {
                isLoading = false;
            }
        }
        
        function renderBooks(books) {
            const grid = document.getElementById('bookGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (books.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            grid.style.display = 'grid';
            emptyState.style.display = 'none';
            
            const loggedIn = isLoggedIn();
            
            grid.innerHTML = books.map(book => `
                <div class="book-card">
                    <h3>${escapeHtml(book.title)}</h3>
                    <p><strong>By:</strong> ${escapeHtml(book.author)}</p>
                    <p><strong>Genre:</strong> ${escapeHtml(book.genre)}</p>
                    <p><strong>ISBN:</strong> ${escapeHtml(book.isbn)}</p>
                    <p class="availability ${book.isAvailable ? '' : 'unavailable'}">
                        ${book.availableCopies} of ${book.totalCopies} available
                    </p>
                    <div class="book-card-actions">
                        <button onclick="viewDetails(${book.bookId})" class="btn-primary">
                            View Details
                        </button>
                        ${loggedIn ? `
                            <button onclick="borrowBookFromCard(${book.bookId}, ${book.isAvailable})" 
                                    class="btn-borrow" 
                                    ${!book.isAvailable ? 'disabled' : ''}>
                                ${book.isAvailable ? 'Borrow' : 'Unavailable'}
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function searchBooks() {
            const search = document.getElementById('searchInput').value;
            const genre = document.getElementById('genreFilter').value;
            loadBooks(search, genre);
        }
        
        function viewDetails(bookId) {
            window.location.href = `book-detail.html?id=${bookId}`;
        }
        
        async function borrowBookFromCard(bookId, isAvailable) {
            if (!isLoggedIn()) {
                showToast('Please login to borrow books', 'warning');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);
                return;
            }
            
            if (!isAvailable) {
                showToast('This book is currently unavailable', 'error');
                return;
            }
            
            const overlay = showLoadingOverlay('Borrowing book...');
            
            try {
                await apiClient.post('/api/loans', {
                    bookId: parseInt(bookId)
                }, true);
                
                hideLoadingOverlay();
                showToast('Book borrowed successfully!', 'success');
                
                setTimeout(() => {
                    loadBooks();
                }, 1500);
                
            } catch (error) {
                hideLoadingOverlay();
                let errorMessage = 'Failed to borrow book. ';
                
                if (error.message.includes('400')) {
                    errorMessage += 'You may have reached the maximum loan limit (5 books).';
                } else if (error.message.includes('401')) {
                    errorMessage += 'Please login again.';
                } else {
                    errorMessage += 'Please try again later.';
                }
                
                showToast(errorMessage, 'error');
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        const debouncedSearch = debounce(() => {
            const search = document.getElementById('searchInput').value;
            const genre = document.getElementById('genreFilter').value;
            loadBooks(search, genre);
        }, 500);
        
        document.getElementById('searchInput').addEventListener('input', debouncedSearch);
        
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchBooks();
            }
        });
        
        document.getElementById('genreFilter').addEventListener('change', () => {
            searchBooks();
        });
        
        loadGenres();
        loadBooks();
    </script>
</body>
</html>
