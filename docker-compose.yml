services:
  seq:
    image: datalust/seq:2024.1
    container_name: libhub-seq
    environment:
      - ACCEPT_EULA=Y
      - SEQ_FIRSTRUN_RETENTION_DAYS=7
    ports:
      - "0.0.0.0:5341:80"
    volumes:
      - seq-data:/data
    networks:
      - libhub-network
    restart: unless-stopped

  consul:
    image: consul:1.15
    container_name: libhub-consul
    ports:
      - "0.0.0.0:8500:8500"
      - "0.0.0.0:8600:8600/udp"
    command: agent -server -ui -bootstrap-expect=1 -client=0.0.0.0
    networks:
      - libhub-network

  mysql:
    image: mysql:8.0
    container_name: libhub-mysql
    ports:
      - "0.0.0.0:3307:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d
    environment:
      MYSQL_ROOT_PASSWORD: LibHub@2025
      MYSQL_USER: libhub_user
      MYSQL_PASSWORD: LibHub@Dev2025
    command: >
      --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - libhub-network

  userservice:
    build:
      context: .
      dockerfile: src/Services/UserService/Dockerfile
    ports:
      - "5002"
    depends_on:
      mysql:
        condition: service_healthy
      consul:
        condition: service_started
      seq:
        condition: service_started
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Server=mysql;Port=3306;Database=user_db;User=libhub_user;Password=LibHub@Dev2025;
      - Jwt__SecretKey=LibHub_SuperSecret_256BitKey_ForDevelopment_ChangeInProduction!
      - Jwt__Issuer=LibHub.UserService
      - Jwt__Audience=LibHub.Clients
      - Consul__Host=consul
      - Consul__Port=8500
      - ServiceConfig__ServiceName=userservice
      - ServiceConfig__ServiceHost=userservice
      - ServiceConfig__ServicePort=5002
      - Serilog__WriteTo__1__Args__serverUrl=http://seq:80
    networks:
      - libhub-network

  catalogservice:
    build:
      context: .
      dockerfile: src/Services/CatalogService/Dockerfile
    ports:
      - "5001"
    depends_on:
      mysql:
        condition: service_healthy
      consul:
        condition: service_started
      seq:
        condition: service_started
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Server=mysql;Port=3306;Database=catalog_db;User=libhub_user;Password=LibHub@Dev2025;
      - Jwt__SecretKey=LibHub_SuperSecret_256BitKey_ForDevelopment_ChangeInProduction!
      - Jwt__Issuer=LibHub.UserService
      - Jwt__Audience=LibHub.Clients
      - Consul__Host=consul
      - Consul__Port=8500
      - ServiceConfig__ServiceName=catalogservice
      - ServiceConfig__ServiceHost=catalogservice
      - ServiceConfig__ServicePort=5001
      - Serilog__WriteTo__1__Args__serverUrl=http://seq:80
    networks:
      - libhub-network

  loanservice:
    build:
      context: .
      dockerfile: src/Services/LoanService/Dockerfile
    ports:
      - "5003"
    depends_on:
      mysql:
        condition: service_healthy
      catalogservice:
        condition: service_started
      consul:
        condition: service_started
      seq:
        condition: service_started
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__DefaultConnection=Server=mysql;Port=3306;Database=loan_db;User=libhub_user;Password=LibHub@Dev2025;
      - Jwt__SecretKey=LibHub_SuperSecret_256BitKey_ForDevelopment_ChangeInProduction!
      - Jwt__Issuer=LibHub.UserService
      - Jwt__Audience=LibHub.Clients
      - ExternalServices__CatalogServiceBaseUrl=http://catalogservice:5001
      - Consul__Host=consul
      - Consul__Port=8500
      - ServiceConfig__ServiceName=loanservice
      - ServiceConfig__ServiceHost=loanservice
      - ServiceConfig__ServicePort=5003
      - Serilog__WriteTo__1__Args__serverUrl=http://seq:80
    networks:
      - libhub-network

  gateway:
    build:
      context: .
      dockerfile: src/Gateway/LibHub.Gateway.Api/Dockerfile
    container_name: libhub-gateway
    ports:
      - "0.0.0.0:5000:5000"
    depends_on:
      consul:
        condition: service_started
      seq:
        condition: service_started
      userservice:
        condition: service_started
      catalogservice:
        condition: service_started
      loanservice:
        condition: service_started
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - Jwt__SecretKey=LibHub_SuperSecret_256BitKey_ForDevelopment_ChangeInProduction!
      - Jwt__Issuer=LibHub.UserService
      - Jwt__Audience=LibHub.Clients
      - Consul__Host=consul
      - Consul__Port=8500
      - Serilog__WriteTo__1__Args__serverUrl=http://seq:80
    networks:
      - libhub-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: libhub-frontend
    ports:
      - "0.0.0.0:8080:8080"
    depends_on:
      - gateway
    networks:
      - libhub-network

networks:
  libhub-network:
    driver: bridge

volumes:
  mysql-data:
  seq-data:
