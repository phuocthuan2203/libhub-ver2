<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Books - LibHub Admin</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <nav>
        <h1>LibHub Admin</h1>
        <div id="navLinks"></div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h2>Manage Books</h2>
            <button onclick="location.href='admin-add-book.html'" class="btn-primary">
                Add New Book
            </button>
        </div>

        <table id="bookTable">
            <thead>
                <tr>
                    <th>ISBN</th>
                    <th>Title</th>
                    <th>Author</th>
                    <th>Genre</th>
                    <th>Total</th>
                    <th>Available</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="bookList">
                <tr><td colspan="7">Loading books...</td></tr>
            </tbody>
        </table>
        
        <div id="errorMessage" class="error-message" style="display: none; margin-top: 1rem;"></div>
        <div id="successMessage" class="success-message" style="display: none; margin-top: 1rem;"></div>
    </div>

    <script src="js/api-client.js"></script>
    <script src="js/auth.js"></script>
    <script>
        requireAdmin();
        updateNavigation();
        
        async function loadBooks() {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.style.display = 'none';
            
            try {
                const books = await apiClient.get('/api/books');
                renderBooks(books);
            } catch (error) {
                console.error('Error loading books:', error);
                errorDiv.textContent = 'Error loading books. Please try again.';
                errorDiv.style.display = 'block';
            }
        }
        
        function renderBooks(books) {
            const tbody = document.getElementById('bookList');
            
            if (books.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No books in catalog</td></tr>';
                return;
            }
            
            tbody.innerHTML = books.map(book => `
                <tr>
                    <td>${escapeHtml(book.isbn)}</td>
                    <td>${escapeHtml(book.title)}</td>
                    <td>${escapeHtml(book.author)}</td>
                    <td>${escapeHtml(book.genre)}</td>
                    <td>${book.totalCopies}</td>
                    <td>${book.availableCopies}</td>
                    <td>
                        <button onclick="editBook(${book.bookId})" class="btn-primary">Edit</button>
                        <button onclick="deleteBook(${book.bookId}, '${escapeHtml(book.title)}')" class="btn-danger">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function editBook(bookId) {
            window.location.href = `admin-edit-book.html?id=${bookId}`;
        }
        
        async function deleteBook(bookId, title) {
            if (!confirm(`Are you sure you want to delete "${title}"?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            try {
                await apiClient.delete(`/api/books/${bookId}`, true);
                
                successDiv.textContent = 'Book deleted successfully!';
                successDiv.style.display = 'block';
                
                setTimeout(() => {
                    successDiv.style.display = 'none';
                    loadBooks();
                }, 1500);
                
            } catch (error) {
                console.error('Delete error:', error);
                let errorMessage = 'Failed to delete book. ';
                
                if (error.message.includes('400')) {
                    errorMessage += 'Book may have active loans.';
                } else {
                    errorMessage += 'Please try again.';
                }
                
                errorDiv.textContent = errorMessage;
                errorDiv.style.display = 'block';
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        loadBooks();
    </script>
</body>
</html>
